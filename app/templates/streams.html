{% extends 'base.html' %}
{% block content %}
<h1>ğŸ¥ Streams ğŸ¶</h1>
<p>Manage your Streams with ease</p>

<!-- alert if flash -->
{% with messages = get_flashed_messages(with_categories=True) %}
{% if messages %}
    {% for category, message in messages %}
        <div class="alert alert-{% if category == 'error' %}danger{% else %}{{ category }}{% endif %}">{{ message }}</div>
    {% endfor %}
{% endif %}
{% endwith %}


<div class="d-flex justify-content-between">
    <a href="#" id="add_stream" class="btn btn-success me-2">â• Add Stream</a>
    <div>
        {% if not user.is_use_api %}
        <a href="{{ url_for('authorize') }}" class="btn btn-primary me-2" title="Authorize to use API">ğŸ”’ Authorize</a>
        {% else %}
        <a href="{{ url_for('revoke') }}" class="btn btn-danger btn-revoke me-2">ğŸ”“ Revoke</a>
        {% endif %}
        {% if is_admin %}
        <a href="{{ url_for('videos') }}" class="btn btn-primary">ğŸ“¹ Videos</a>
        {% endif %}
    </div>
</div>

<div class="row mt-4">
    {% for stream in streams %}
    <div class="col-md-4" id="stream-{{ stream.id }}">
        <div class="card mb-3 shadow-lg border-0">
            <div class="card-body">
                <h5 class="card-title text-primary">ğŸµ {{ stream.judul }}</h5>
                <p class="card-text">{{ stream.deskripsi|truncate(100) }}</p>
                {% if is_admin %}
                    <p class="card-text"><strong>Created by:</strong> {{ stream.user.username }}</p>
                {% endif %}
                <p class="card-text"><strong>Start at:</strong> ğŸ¬ {{ stream.start_at }}</p>
                <p class="card-text"><strong>End at:</strong> ğŸ›‘ {{ stream.end_at }}</p>
                <button class="btn-detail w-100 mb-4" data-id="{{ stream.id }}">â¬‡ï¸ show more </button>
                <div id="details-{{ stream.id }}" class="stream-details" style="display: none;">
                    <p class="card-text" title="{{stream.kode_stream}}"><strong>Stream Key:</strong> ğŸ”‘ {{ '*' * (stream.kode_stream|length - 3) }}</p>
                    <p class="card-text"><strong>Video:</strong> ğŸ“¹ {{ stream.video.judul|truncate(20) }}</p>
                    <p class="card-text"><strong>Status:</strong> {% if stream.is_active %}âœ”ï¸ Active{% else %}âŒ Inactive{% endif %}</p>
                    <p class="card-text"><strong>Duration:</strong> <span id="duration-stream-{{ stream.id }}">{{ stream.duration }}</span></p>
                    <p class="card-text"><strong>Repeat:</strong> {% if stream.is_repeat %}ğŸ” Yes{% else %}âŒ No{% endif %}</p>
                </div>
                <div class="mt-4">
                {% if not stream.is_active %}
                    <a href="{{ url_for('start_stream', id=stream.id) }}" id="start-{{ stream.id }}" data-id="{{ stream.id }}" class="start_stream btn btn-primary">â–¶ï¸ Start</a>
                {% else %}
                    <a href="{{ url_for('stop_stream', id=stream.id) }}" id="stop-{{ stream.id }}" data-id="{{ stream.id }}" class="stop_stream btn btn-danger">â¸ï¸ Stop</a>
                {% endif %}
                <a href="{{ url_for('edit_stream', id=stream.id) }}" id="edit-{{ stream.id }}" class="btn btn-warning">âœï¸ Edit</a>
                <a href="{{ url_for('delete_stream', id=stream.id) }}" id="delete-{{ stream.id }}" class="btn btn-danger">ğŸ—‘ï¸ Delete</a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- modal add streams -->
<div class="modal fade" id="addStreamModal" tabindex="-1" aria-labelledby="addStreamModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addStreamModalLabel">Add Stream</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="" enctype="multipart/form-data" method="post">
                    {{ form.hidden_tag() }}
                    <div class="mb-3">
                        <label for="video">Video</label>
                        <select name="video_id" id="video" class="form-control" required>
                            {% if videos|length == 0 %}
                                <option value="">No Video - Upload first</option>
                            {% else %}
                                <option value="">Select a Video</option>
                            {% endif %}
                            {% for video in videos %}
                                <option value="{{ video.id }}">{{ video.judul }} - {{ video.deskripsi|truncate(20, True) }}</option>
                            {% endfor %}
                        </select>
                        {% if videos|length == 0 %}
                            <a href="{{ url_for('videos') }}" class="btn btn-primary mt-2">ğŸ“¹ Upload Video</a>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ form.judul.label(class="form-label") }}
                        {{ form.judul(class="form-control", autofocus=True) }}
                    </div>
                    <div class="mb-3">
                        {{ form.deskripsi.label(class="form-label") }}
                        {{ form.deskripsi(class="form-control") }}
                    </div>
                    {% if not user.is_use_api %}
                    <div class="mb-3">
                        {{ form.kode_stream.label(class="form-label") }}
                        {{ form.kode_stream(class="form-control") }}
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        {{ form.start_at.label(class="form-label") }} <i class="bi bi-clock"></i>
                        {{ form.start_at(class="form-control") }}
                    </div>
                    <div class="mb-3">
                        {{ form.end_at.label(class="form-label") }} <i class="bi bi-clock"></i>
                        {{ form.end_at(class="form-control") }}
                    </div>
                    <div class="mb-3">
                        {{ form.is_repeat.label(class="form-check-label") }}
                        {{ form.is_repeat(class="form-check-input form-control") }}
                    </div>
                    <button type="submit" class="btn btn-primary form-control">Add Stream</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script>
    $(document).ready(function () {
        const socket = io();
        $('#add_stream').click(function () {
            $('input[name="judul"]').focus();
            $('#addStreamModal').modal('show');
        });
        $('.start_stream').click(function (e) {
            e.preventDefault();
            /* Act on the event 
            */
            var btn_text = $(this).text();
            Swal.fire({
                title: `Are you sure to ${btn_text}?`,
                text: "You will not be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: `Yes, ${btn_text} it!`,
                cancelButtonText: 'No, keep it'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/start_stream/${$(this).data('id')}`,
                        success: function (data) {
                            if (data.status === 'success'){
                                // sweet alert 2 notification
                                Swal.fire("Success", data.message, "success");
                            }
                            setInterval(function(){
                                window.location.reload();
                            }, 1500);
                        }
                    });
                }
            });
        });
        
        // stop stream
        $('.stop_stream').click(function (e) {
            e.preventDefault();
            /* Act on the event 
            */
            var btn_text = $(this).text();
            Swal.fire({
                title: `Are you sure to ${btn_text}?`,
                text: "You will not be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: `Yes, ${btn_text} it!`,
                cancelButtonText: 'No, keep it'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/stop_stream/${$(this).data('id')}`,
                        success: function (data) {
                            if (data.status === 'success'){
                                // sweet alert 2 notification
                                Swal.fire("Success", data.message, "success");
                            }
                            setInterval(function(){
                                window.location.reload();
                            }, 1500);
                        }
                    });
                }
            });
        });

        $('.btn-danger').click(function (e) {
            e.preventDefault();

            var btn_text = $(this).text();
            Swal.fire({
                title: `Are you sure to ${btn_text}?`,
                text: "You will not be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: `Yes, ${btn_text} it!`,
                cancelButtonText: 'No, keep it'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: $(this).attr('href'),
                        success: function (data) {
                            if (data.status === 'success'){
                                // sweet alert 2 notification
                                Swal.fire("Success", data.message, "success").then((result) => {
                                    setInterval(function(){
                                        window.location.reload();
                                    }, 1500);
                                });
                            }
                        }
                    });
                }
            });
            
        });
        var length_updated = 0;
        socket.on('update_streams', (msg) => {
            {% if is_admin %}
                const stream_id = msg.id;
                if ($(`#stream-${stream_id}`).length > 0){
                    location.reload();
                }
            {% else %}
            if (msg.user_id == {{ user.id }}){
                // update only on .card-body
                window.location.reload();
            }
            {% endif %}
        });

        // if video selected
        $('#video').change(function () {
            const video_id = $(this).val();
            if (video_id === ''){
                return;
            }
            $.ajax({
                url: `/video/${video_id}`,
                success: function (data) {
                    $('input[name="judul"]').val(data.video.judul);
                    $('textarea[name="deskripsi"]').text(data.video.deskripsi);
                },
                error: function (err) {
                    Swal.fire("Error", "Failed to get video data", "error");
                }
            });
        });

        // detail stream
        $('.btn-detail').click(function () {
            const stream_id = $(this).data('id');
            $(`#details-${stream_id}`).toggle();
            // change text
            if ($(`#details-${stream_id}`).is(':visible')){
                // change btn location
                $('html, body').animate({
                    scrollTop: $(`#details-${stream_id}`).offset().top
                }, 1000);
                $(this).text('â¬†ï¸ show less ');
            } else {
                $(this).text('â¬‡ï¸ show more ');
            }
        });

        socket.on('update_duration', (msg) => {
            
            {% if is_admin %}
                $('span#duration-stream-'+msg.id).text(msg.duration);
            {% else %}
            if (msg.user_id == {{ user.id }}){
                $('span#duration-stream-'+msg.id).text(msg.duration);
            }
            {% endif %}
        });
    });
</script>
{% endblock %}
